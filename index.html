<!DOCTYPE html>
<html>

<head>
    <title>worklogger</title>
    <style>
        @import url('https://fonts.googleapis.com/css?family=Tajawal');
        @import url('https://fonts.googleapis.com/css?family=Raleway');

        body {
            height: 100vh;
            margin: 0;
            font-family: 'Raleway';
        }

        #app {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #app header {
            color: white;
            background-color: #330066;
            flex: 2;
            font-family: 'Tajawal', sans-serif;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #app main {
            flex: 18;
            display: flex;
            align-items: center;
            justify-content: space-around;
            flex-direction: column;
        }

        #app footer {
            flex: 1;
            text-align: left;
            padding: 10px;
            background-color: #eee;
            display: flex;
            align-items: center;
        }

        input,
        select,
        textarea {
            border: none;
            background-color: transparent;
            border-bottom: 2px solid #330066;
            width: 60vw;
        }

        .input-group,
        .search-box {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 10px;
        }

        .search-results {
            list-style: none;
            padding: 0;
            position: absolute;
            max-height: 40vh;
            overflow-y: scroll;
            overflow-x: hidden;
            background-color: white;
            width: 100%;
        }

        .search-result {
            padding: 10px 10px 10px 0;
            cursor: pointer;
        }

        .search-input {
            position: relative;
        }

        .button {
            padding: 10px 0;
            color: #fff;
            border: none;
            border-radius: 20px;
            min-width: 140px;
            display: inline-block;
            text-align: center;
            background-color: #38e090;
            cursor: pointer;
            -webkit-transition: .3s linear;
            -moz-transition: .3s linear;
            -ms-transition: .3s linear;
            -o-transition: .3s linear;
            transition: .3s linear;
        }
        
        .button:hover {
            transform: scale(1.1);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
</head>

<body>
<div id="app">
    <header>
        <h1>worklogger</h1>
    </header>

    <main>
        <div class="input-group">
            <div class="search-box">
                <label for="search-issue">Search Issue</label>
                <div class="search-input">
                    <input id="search-issue" type="text" name="search-issue" @keyup="filterIssues" @click="filterIssues" v-model="query"
                           :disabled="!issuesLoaded" :placeholder="searchPlaceholder" autofocus>
                    <ul v-show="showSearchResults" class="search-results">
                        <li v-for="issue in filteredIssues" :value="issue.key" @click="setIssueKey(issue.key)"
                            class="search-result">
                            {{ issue.key }} - {{ issue.fields.summary }}
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="input-group">
            <label for="date-time">Date</label>
            <input id="date-time" name="date-time" type="datetime-local" v-model="date" :value="date">
        </div>

        <div class="input-group">
            <label for="time-spent">Time Spent</label>
            <input id="time-spent" name="time-spent" type="text">
        </div>

        <div class="input-group">
            <label for="description" v-model="comment">Description</label>
            <textarea id="description" name="description" :value="comment"></textarea>
        </div>

        <button class="button" @click="sendWorklog">Send</button>
    </main>

    <footer>
      <span>Made with love by
        <a href="https://ubykuo.com"> ubykuo</a>
      </span>
    </footer>
</div>

<script>
    var onClickOutside = require('vue-on-click-outside').mixin;
    JiraApi = require('jira-client');

    new Vue({
        el: '#app',
        data: {
            jira: new JiraApi({
                protocol: 'https',
                host: 'ubykuo.atlassian.net',
                username: 'admin',
                password: 'vamoalmega95',
                apiVersion: '2',
                strictSSL: true
            }),
            issues: [],
            issuesLoaded: false,
            filteredIssues: [],
            issueKey: '',
            query: '',
            searchEnabledPlaceholder: 'Search for issues by key, for example IT-17',
            searchDisabledPlaceholder: 'Issues loading, please wait...',
            searchPlaceholder: '',
            showSearchResults: false,
            date: new Date(),
            comment: 'Algo'
        },
        created () {
            this.getUserIssues('admin');
            this.setSearchPlaceholder()
        },
        methods: {
            getUserIssues (username) {
                this.jira.getUsersIssues(username, false)
                    .then(function (response) {
                        console.log(response);
                        this.issues = response.issues;
                        this.issuesLoaded = true;
                        this.setSearchPlaceholder()
                    }.bind(this));
            },
            filterIssues: function filterIssues () {
                this.filteredIssues = this.issues.filter(function (issue) {
                    return issue.key.search(this.query) !== -1 || issue.fields.summary.toLowerCase().search(this.query.toLowerCase()) !== -1;
                }.bind(this));
                this.setShowSearchResults(true);
                console.log(this.filteredIssues);
            },

            setIssueKey (key) {
                this.issueKey = this.query = key;
                this.setShowSearchResults(false);
            },

            getSearchPlaceholder () {
                return this.issuesLoaded ? this.searchEnabledPlaceholder : this.searchDisabledPlaceholder;
            },

            setSearchPlaceholder () {
                this.searchPlaceholder = this.getSearchPlaceholder()
            },

            setShowSearchResults (show) {
                this.showSearchResults = show;
            },

            sendWorklog () {
                this.jira.addWorklog('IT-139', {
                    timeSpent: '1m',
                    timeSpentInSeconds: '60',
                    comment: this.comment,
                    started: '2013-09-01T10:30:18.932+0530'
                }, {})
                    .then(response => console.log(response))
                    .catch(error => console.log(error))
            }
        },
        computed: {

        },
        mixins: [onClickOutside]
    })
</script>

<script>
    /**
     * @see https://github.com/nwjs/nw.js/wiki/Livereload-nw.js-on-changes
     */
    var path = './';
    var fs = require('fs');

    var reloadWatcher=fs.watch(path, function() {
        location.reload();
        reloadWatcher.close();
    });
</script>
</body>

</html>